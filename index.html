<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKYWATCH ENTERPRISE | COMMAND OS</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

    <style>
        /* =================================================================
           1.0 CSS VARIABLES & THEME ENGINE
           ================================================================= */
        :root {
            /* Base Colors */
            --bg-void: #000000;
            --bg-depth: #050505;
            --bg-panel: #0a0b10;
            --bg-glass: rgba(10, 15, 20, 0.95);
            
            /* UI Borders */
            --border-dim: #1e293b;
            --border-mid: #334155;
            --border-bright: #475569;
            --border-active: #00f3ff;

            /* Accent Colors */
            --cyan: #00f3ff;
            --cyan-dim: rgba(0, 243, 255, 0.1);
            --green: #10b981;
            --green-dim: rgba(16, 185, 129, 0.1);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.1);
            --amber: #f59e0b;
            --amber-dim: rgba(245, 158, 11, 0.1);
            --purple: #8b5cf6;
            
            /* Typography */
            --font-ui: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-mono: 'Courier New', Courier, monospace;
            --font-tech: 'Share Tech Mono', monospace;

            /* Effects */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-neon: 0 0 10px var(--cyan);
            --shadow-win: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
            
            --blur-strength: 12px;
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* =================================================================
           2.0 RESET & GLOBAL UTILITIES
           ================================================================= */
        *, *::before, *::after {
            box-sizing: border-box;
            user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-void);
            color: #e2e8f0;
            font-family: var(--font-ui);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            cursor: default;
        }

        /* Utility Classes (Bootstrap-style for rapid dev) */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-row { flex-direction: row; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .grow { flex-grow: 1; }
        
        .p-1 { padding: 4px; }
        .p-2 { padding: 8px; }
        .p-4 { padding: 16px; }
        .px-2 { padding-left: 8px; padding-right: 8px; }
        .py-2 { padding-top: 8px; padding-bottom: 8px; }
        
        .m-0 { margin: 0; }
        .mb-2 { margin-bottom: 8px; }
        .mt-2 { margin-top: 8px; }
        .mr-2 { margin-right: 8px; }
        
        .text-xs { font-size: 10px; }
        .text-sm { font-size: 12px; }
        .text-base { font-size: 14px; }
        .text-lg { font-size: 18px; }
        .text-xl { font-size: 24px; }
        
        .font-bold { font-weight: 700; }
        .font-mono { font-family: var(--font-mono); }
        .uppercase { text-transform: uppercase; }
        .tracking-wide { letter-spacing: 1px; }
        
        .text-cyan { color: var(--cyan); }
        .text-red { color: var(--red); }
        .text-green { color: var(--green); }
        .text-amber { color: var(--amber); }
        .text-muted { color: #64748b; }
        
        .bg-black { background: #000; }
        .bg-panel { background: var(--bg-panel); }
        
        .border { border: 1px solid var(--border-mid); }
        .border-b { border-bottom: 1px solid var(--border-mid); }
        .rounded { border-radius: 4px; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-void); }
        ::-webkit-scrollbar-thumb { background: var(--border-mid); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--cyan); }

        /* =================================================================
           3.0 UI COMPONENTS
           ================================================================= */
        
        /* CRT Effect */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 100000;
            opacity: 0.08;
        }

        /* Buttons */
        .btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-mid);
            color: #e2e8f0;
            padding: 8px 16px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 2px;
        }
        .btn:hover {
            background: var(--cyan-dim);
            color: var(--cyan);
            border-color: var(--cyan);
            box-shadow: 0 0 10px var(--cyan-dim);
        }
        .btn:active { transform: translateY(1px); }
        
        .btn-red:hover { background: var(--red-dim); color: var(--red); border-color: var(--red); box-shadow: 0 0 10px var(--red-dim); }
        .btn-green:hover { background: var(--green-dim); color: var(--green); border-color: var(--green); box-shadow: 0 0 10px var(--green-dim); }

        /* Inputs */
        input[type="text"], input[type="password"], textarea, select {
            background: #050608;
            border: 1px solid var(--border-mid);
            color: #fff;
            padding: 10px;
            font-family: var(--font-mono);
            font-size: 12px;
            outline: none;
            transition: var(--transition-fast);
            width: 100%;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--cyan);
            box-shadow: 0 0 10px var(--cyan-dim);
        }

        /* Loaders */
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid var(--border-mid);
            border-top: 2px solid var(--cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* =================================================================
           4.0 BOOT & LOGIN SCREENS
           ================================================================= */
        #boot-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 99999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        .bios-text {
            font-family: var(--font-mono);
            color: #aaa;
            font-size: 12px;
            width: 600px;
            height: 400px;
            overflow: hidden;
            white-space: pre-wrap;
        }

        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            z-index: 99990;
            display: none; /* Hidden until boot finishes */
            align-items: center; justify-content: center;
            flex-direction: column;
        }

        .login-box {
            width: 400px;
            background: var(--bg-panel);
            border: 1px solid var(--border-mid);
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative;
        }
        .login-box::before {
            content: ""; position: absolute; top: -1px; left: -1px; right: -1px; height: 2px;
            background: var(--cyan); box-shadow: var(--shadow-neon);
        }

        .user-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background: #222; margin: 0 auto 20px;
            border: 2px solid var(--cyan);
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: var(--cyan);
        }

        /* =================================================================
           5.0 DESKTOP ENVIRONMENT
           ================================================================= */
        #desktop-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(circle at 50% 50%, #0d1117 0%, #000 100%),
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: cover, 50px 50px, 50px 50px;
            display: none;
            overflow: hidden;
        }

        /* Desktop Icons */
        .icon-container {
            position: absolute; top: 20px; left: 20px; bottom: 60px; width: 100px;
            display: flex; flex-direction: column; gap: 10px; flex-wrap: wrap;
        }
        
        .shortcut {
            width: 90px; height: 100px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid transparent; border-radius: 4px;
            cursor: pointer; transition: var(--transition-fast);
            color: #94a3b8;
        }
        .shortcut:hover {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
            color: #fff;
        }
        .shortcut i { font-size: 36px; margin-bottom: 8px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .shortcut span { font-size: 11px; text-shadow: 1px 1px 2px #000; text-align: center; line-height: 1.2; font-weight: 500; }

        /* =================================================================
           6.0 WINDOW SYSTEM
           ================================================================= */
        .window-shell {
            position: absolute;
            background: var(--bg-glass);
            border: 1px solid var(--border-mid);
            backdrop-filter: blur(var(--blur-strength));
            box-shadow: var(--shadow-win);
            display: flex; flex-direction: column;
            overflow: hidden;
            min-width: 300px; min-height: 200px;
            border-radius: 4px;
            animation: winOpen 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            color: var(--text);
        }
        @keyframes winOpen { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .window-shell.active {
            border-color: var(--cyan);
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .win-bar {
            height: 36px;
            background: rgba(0,0,0,0.4);
            border-bottom: 1px solid var(--border-dim);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 12px; cursor: default;
            user-select: none;
        }
        
        .win-title {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1px; color: var(--cyan);
            display: flex; align-items: center; gap: 8px;
        }
        
        .win-actions { display: flex; gap: 8px; }
        .win-btn { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; transition: 0.1s; position: relative; }
        .wb-close { background: #ef4444; } .wb-close:hover { background: #ff6b6b; }
        .wb-max { background: #10b981; } .wb-max:hover { background: #34d399; }
        .wb-min { background: #f59e0b; } .wb-min:hover { background: #fbbf24; }

        .win-content { flex: 1; overflow: hidden; position: relative; background: rgba(0,0,0,0.2); }

        /* =================================================================
           7.0 TASKBAR
           ================================================================= */
        #taskbar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 45px;
            background: rgba(5, 5, 8, 0.9);
            border-top: 1px solid var(--border-mid);
            display: flex; align-items: center; padding: 0 10px;
            z-index: 99999; backdrop-filter: blur(10px);
        }

        #start-menu-btn {
            height: 32px; padding: 0 15px;
            background: var(--cyan); color: #000;
            font-weight: 800; font-size: 13px; letter-spacing: 1px;
            display: flex; align-items: center; gap: 8px;
            border-radius: 2px; cursor: pointer; transition: 0.2s;
            margin-right: 15px;
        }
        #start-menu-btn:hover { background: #fff; box-shadow: var(--shadow-neon); }

        #task-tray { display: flex; height: 100%; gap: 4px; flex: 1; }
        
        .task-tab {
            width: 160px; height: 100%;
            display: flex; align-items: center; gap: 8px; padding: 0 15px;
            font-size: 11px; color: #94a3b8;
            border-bottom: 2px solid transparent;
            cursor: pointer; transition: 0.2s; background: transparent;
        }
        .task-tab:hover { background: rgba(255,255,255,0.03); color: #fff; }
        .task-tab.active { background: rgba(255,255,255,0.05); color: #fff; border-bottom-color: var(--cyan); }
        .task-tab img, .task-tab i { font-size: 14px; }

        #sys-tray {
            display: flex; gap: 20px; font-size: 11px; font-family: var(--font-mono); color: var(--cyan); margin-left: auto; padding-right: 10px;
        }

        /* =================================================================
           8.0 START MENU
           ================================================================= */
        #start-menu {
            position: absolute; bottom: 50px; left: 10px;
            width: 350px; height: 500px;
            background: var(--bg-glass);
            border: 1px solid var(--border-mid);
            border-radius: 6px;
            display: none;
            flex-direction: column;
            z-index: 99998;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .menu-header {
            padding: 20px; background: linear-gradient(135deg, #111, #000);
            border-bottom: 1px solid var(--border-mid); display: flex; align-items: center; gap: 15px;
        }
        .menu-user-img { width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; color: var(--cyan); border: 2px solid var(--cyan); }
        .menu-user-name { font-weight: bold; font-size: 14px; color: #fff; }
        .menu-user-rank { font-size: 10px; color: var(--cyan); text-transform: uppercase; letter-spacing: 1px; }

        .menu-grid {
            padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; flex: 1; align-content: start;
        }
        .menu-item {
            padding: 10px; display: flex; align-items: center; gap: 10px; color: #ccc;
            cursor: pointer; border-radius: 4px; transition: 0.1s;
        }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: #fff; }

        .menu-footer {
            padding: 15px; border-top: 1px solid var(--border-mid); background: rgba(0,0,0,0.5);
            display: flex; justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>

    <div id="boot-layer">
        <div style="font-family: 'Courier New'; color: var(--cyan); width: 600px;">
            <div id="bios-output" style="white-space: pre-wrap; font-size: 12px; margin-bottom: 20px;"></div>
            <div style="width: 100%; height: 4px; background: #222;">
                <div id="boot-bar" style="width: 0%; height: 100%; background: var(--cyan); box-shadow: 0 0 10px var(--cyan);"></div>
            </div>
        </div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <div class="user-avatar"><i class="fas fa-user-astronaut"></i></div>
            <h2 style="margin: 10px 0; color: #fff; letter-spacing: 2px;">COMMANDER</h2>
            <p style="color: #666; font-size: 11px; margin-bottom: 20px;">SECURITY LEVEL 5 // TOP SECRET</p>
            
            <input type="password" id="login-pwd" placeholder="ENTER ACCESS CODE" style="text-align: center; font-size: 14px; letter-spacing: 3px;">
            <button class="btn btn-green w-full mt-2" onclick="Kernel.login()">AUTHENTICATE</button>
            <div id="login-msg" style="color: var(--red); font-size: 10px; margin-top: 10px; height: 15px;"></div>
        </div>
    </div>

    <div id="desktop-layer">
        <div class="icon-container" id="desktop-icons"></div>

        <div id="start-menu">
            <div class="menu-header">
                <div class="menu-user-img"><i class="fas fa-user"></i></div>
                <div>
                    <div class="menu-user-name">Commander Fahad</div>
                    <div class="menu-user-rank">System Administrator</div>
                </div>
            </div>
            <div class="menu-grid" id="menu-list"></div>
            <div class="menu-footer">
                <button class="btn btn-red" onclick="Kernel.reboot()"><i class="fas fa-power-off"></i> SHUTDOWN</button>
                <button class="btn" onclick="Kernel.lock()"><i class="fas fa-lock"></i> LOCK</button>
            </div>
        </div>

        <div id="taskbar">
            <div id="start-menu-btn" onclick="UI.toggleStartMenu()">
                <i class="fab fa-windows"></i> START
            </div>
            <div id="task-tray"></div>
            <div id="sys-tray">
                <span><i class="fas fa-shield-alt"></i> SECURE</span>
                <span><i class="fas fa-wifi"></i> 10Gbps</span>
                <span id="clock-display">00:00</span>
            </div>
        </div>
        <script>

    /* -------------------------------------------------------------------------
       SYSTEM AUDIO ENGINE (Web Audio API)
       Generates procedural sci-fi UI sounds without external files.
       ------------------------------------------------------------------------- */
    const AudioSys = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        
        playTone: function(freq, type, duration, vol = 0.1) {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        },

        sfx: function(id) {
            if (this.ctx.state === 'suspended') this.ctx.resume();
            switch(id) {
                case 'boot':
                    this.playTone(100, 'square', 1.0, 0.2);
                    setTimeout(() => this.playTone(200, 'square', 0.5, 0.2), 200);
                    break;
                case 'hover': this.playTone(400, 'sine', 0.05, 0.05); break;
                case 'click': this.playTone(800, 'triangle', 0.1, 0.1); break;
                case 'open': this.playTone(600, 'sine', 0.3, 0.1); break;
                case 'close': this.playTone(300, 'sine', 0.3, 0.1); break;
                case 'error': this.playTone(150, 'sawtooth', 0.4, 0.2); break;
                case 'scan': 
                    let t = 0;
                    const scanInt = setInterval(() => {
                        this.playTone(800 + (Math.random()*200), 'square', 0.05, 0.05);
                        t++; if(t>10) clearInterval(scanInt);
                    }, 50);
                    break;
            }
        }
    };

    /* -------------------------------------------------------------------------
       KERNEL: OPERATING SYSTEM CORE
       ------------------------------------------------------------------------- */
    const Kernel = {
        windows: {},
        zTop: 100,
        processes: {},
        apps: {}, // Registered Applications

        // --- BOOT SEQUENCE ---
        init: function() {
            let progress = 0;
            const bar = document.getElementById('boot-bar');
            const log = document.getElementById('bios-output');
            const msgs = [
                "LOADING KERNEL...", "MOUNTING VIRTUAL FILESYSTEM...", 
                "INITIALIZING NEURAL NETWORKS...", "CONNECTING TO SATELLITE ARRAY...",
                "DECRYPTING SECURE SECTORS...", "STARTING GUI...", "ACCESS GRANTED"
            ];
            
            let msgIndex = 0;
            const bootLoop = setInterval(() => {
                progress += Math.random() * 8;
                if(progress > 100) progress = 100;
                bar.style.width = progress + "%";
                
                if(Math.random() > 0.7 && msgIndex < msgs.length) {
                    log.innerText += `\n> ${msgs[msgIndex]} [OK]`;
                    log.scrollTop = log.scrollHeight;
                    msgIndex++;
                }

                if(progress === 100) {
                    clearInterval(bootLoop);
                    setTimeout(() => {
                        document.getElementById('boot-layer').style.display = 'none';
                        document.getElementById('login-screen').style.display = 'flex';
                        AudioSys.sfx('boot');
                    }, 500);
                }
            }, 100);
            
            // Start Clock
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-display').innerText = now.toISOString().split('T')[1].split('.')[0] + " ZULU";
            }, 1000);
        },

        // --- LOGIN ---
        login: function() {
            // Simulated login - accepts any input for demo purposes
            const btn = document.querySelector('#login-screen .btn');
            btn.innerHTML = `<div class="spinner"></div> AUTHENTICATING...`;
            
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('desktop-layer').style.display = 'block';
                AudioSys.sfx('boot');
                this.initDesktop();
            }, 1000);
        },

        reboot: function() {
            location.reload();
        },

        lock: function() {
            document.getElementById('desktop-layer').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.querySelector('#login-screen .btn').innerText = "AUTHENTICATE";
        },

        // --- DESKTOP MANAGER ---
        initDesktop: function() {
            // Render Icons
            const container = document.getElementById('desktop-icons');
            const menu = document.getElementById('menu-list');
            container.innerHTML = '';
            menu.innerHTML = '';

            Object.keys(this.apps).forEach(key => {
                const app = this.apps[key];
                
                // Desktop Shortcut
                container.innerHTML += `
                    <div class="shortcut" ondblclick="Kernel.open('${key}')">
                        <i class="${app.icon}" style="color:${app.color}"></i>
                        <span>${app.title}</span>
                    </div>`;

                // Start Menu Item
                menu.innerHTML += `
                    <div class="menu-item" onclick="Kernel.open('${key}'); UI.toggleStartMenu();">
                        <i class="${app.icon}" style="color:${app.color}; width:20px;"></i>
                        <span>${app.title}</span>
                    </div>`;
            });
        },

        // --- WINDOW MANAGER ---
        open: function(appId) {
            AudioSys.sfx('open');
            const app = this.apps[appId];
            if(!app) return;

            this.zTop++;
            const winId = `win_${appId}_${Date.now()}`;
            
            // Create Window HTML
            const win = document.createElement('div');
            win.className = 'window-shell active';
            win.id = winId;
            win.style.zIndex = this.zTop;
            win.style.width = (app.w || 800) + 'px';
            win.style.height = (app.h || 600) + 'px';
            win.style.top = (50 + (Object.keys(this.windows).length * 30)) + 'px';
            win.style.left = (50 + (Object.keys(this.windows).length * 30)) + 'px';
            
            win.innerHTML = `
                <div class="win-bar" onmousedown="Kernel.dragStart(event, '${winId}')">
                    <div class="win-title"><i class="${app.icon}"></i> ${app.title}</div>
                    <div class="win-actions">
                        <div class="win-btn wb-min" onclick="Kernel.minimize('${winId}')"></div>
                        <div class="win-btn wb-max" onclick="Kernel.maximize('${winId}')"></div>
                        <div class="win-btn wb-close" onclick="Kernel.close('${winId}')"></div>
                    </div>
                </div>
                <div class="win-content" id="${winId}-content">
                    ${app.html(winId)} </div>
            `;

            document.getElementById('desktop-layer').appendChild(win);
            this.windows[winId] = { id: winId, maximized: false };
            
            this.updateTaskbar(winId, app.title, app.icon);

            // Run App Init Script if exists
            if(app.init) setTimeout(() => app.init(winId), 100);
        },

        close: function(winId) {
            AudioSys.sfx('close');
            const el = document.getElementById(winId);
            if(el) {
                el.style.transform = "scale(0.9)";
                el.style.opacity = "0";
                setTimeout(() => el.remove(), 200);
            }
            delete this.windows[winId];
            
            // Remove Taskbar Item
            const task = document.getElementById(`task-${winId}`);
            if(task) task.remove();
        },

        maximize: function(winId) {
            const el = document.getElementById(winId);
            const state = this.windows[winId];
            
            if(!state.maximized) {
                state.prevCss = el.style.cssText;
                el.style.top = '0'; el.style.left = '0';
                el.style.width = '100%'; el.style.height = 'calc(100% - 45px)';
                state.maximized = true;
            } else {
                el.style.cssText = state.prevCss;
                state.maximized = false;
            }
        },

        minimize: function(winId) {
            const el = document.getElementById(winId);
            el.style.display = 'none';
            const task = document.getElementById(`task-${winId}`);
            if(task) task.classList.remove('active');
        },

        focus: function(winId) {
            const el = document.getElementById(winId);
            if(!el) return; // Might be minimized
            el.style.display = 'flex';
            
            this.zTop++;
            el.style.zIndex = this.zTop;
            
            // Visual Updates
            document.querySelectorAll('.window-shell').forEach(w => w.classList.remove('active'));
            el.classList.add('active');
            
            document.querySelectorAll('.task-tab').forEach(t => t.classList.remove('active'));
            const task = document.getElementById(`task-${winId}`);
            if(task) task.classList.add('active');
        },

        // --- DRAG & DROP LOGIC ---
        dragStart: function(e, winId) {
            this.focus(winId);
            const win = document.getElementById(winId);
            
            // Prevent dragging if maximized
            if(this.windows[winId].maximized) return;

            let shiftX = e.clientX - win.getBoundingClientRect().left;
            let shiftY = e.clientY - win.getBoundingClientRect().top;

            const moveAt = (pageX, pageY) => {
                // Bounds checking
                let newX = pageX - shiftX;
                let newY = pageY - shiftY;
                if(newY < 0) newY = 0; // Don't go above screen
                
                win.style.left = newX + 'px';
                win.style.top = newY + 'px';
            }

            const onMouseMove = (event) => moveAt(event.pageX, event.pageY);

            document.addEventListener('mousemove', onMouseMove);

            win.onmouseup = () => {
                document.removeEventListener('mousemove', onMouseMove);
                win.onmouseup = null;
            };
        },

        updateTaskbar: function(winId, title, icon) {
            const tray = document.getElementById('task-tray');
            const tab = document.createElement('div');
            tab.className = 'task-tab active';
            tab.id = `task-${winId}`;
            tab.innerHTML = `<i class="${icon}"></i> ${title.substring(0, 15)}...`;
            tab.onclick = () => this.focus(winId);
            tray.appendChild(tab);
        },

        registerApp: function(id, config) {
            this.apps[id] = config;
        }
    };

    /* -------------------------------------------------------------------------
       UI HELPERS
       ------------------------------------------------------------------------- */
    const UI = {
        toggleStartMenu: () => {
            const menu = document.getElementById('start-menu');
            if(menu.style.display === 'flex') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'flex';
                AudioSys.sfx('click');
            }
        },
        
        // Close start menu if clicked outside
        initListeners: () => {
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('start-menu');
                const btn = document.getElementById('start-menu-btn');
                if(!menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.style.display = 'none';
                }
            });
        }
    };

    // Run UI Listeners
    UI.initListeners();

</script>
        <script>
    /* -------------------------------------------------------------------------
       THE BLACK VAULT: SIMULATED INTELLIGENCE DATABASE
       ------------------------------------------------------------------------- */
    const BlackVault = {
        // Mock Intel for Offline Demos (Fallback if APIs fail)
        intel: [
            { id: 101, source: "SAT-LINK", type: "IMAGERY", title: "New Silo Construction Detected", date: "2026-05-12", threat: "HIGH" },
            { id: 102, source: "INTERCEPT", type: "SIGINT", title: "Encrypted Comms: Unit 774", date: "2026-05-11", threat: "MED" },
            { id: 103, source: "OPEN-SRC", type: "WEB", title: "J-35 Prototype Spotted in Testing", date: "2026-05-10", threat: "LOW" },
            { id: 104, source: "DARKNET", type: "HUMINT", title: "Zero-Day Exploit Sale (Grid)", date: "2026-05-09", threat: "CRIT" },
            { id: 105, source: "REDDIT", type: "SOCIAL", title: "Leaked Manual: Drone Control Sys", date: "2026-05-08", threat: "MED" },
            { id: 106, source: "FINANCIAL", type: "OSINT", title: "Unusual Aluminum Futures Buy", date: "2026-05-07", threat: "LOW" },
            { id: 107, source: "SAT-LINK", type: "THERMAL", title: "Reactor Heat Spike: Sector 4", date: "2026-05-06", threat: "HIGH" },
            { id: 108, source: "DEPT-DEF", type: "OFFICIAL", title: "Budget Appropriation Bill", date: "2026-05-05", threat: "NONE" }
        ],

        // Mock Stock Data
        stocks: [
            { sym: "LMT", name: "Lockheed Martin", price: 450.23, change: 1.2 },
            { sym: "RTX", name: "Raytheon Tech", price: 98.45, change: -0.5 },
            { sym: "NOC", name: "Northrop Grumman", price: 470.10, change: 0.8 },
            { sym: "BA", name: "Boeing Defense", price: 210.33, change: -1.2 },
            { sym: "PLTR", name: "Palantir Tech", price: 22.50, change: 3.4 },
            { sym: "GD", name: "General Dynamics", price: 245.60, change: 0.2 },
            { sym: "SAIC", name: "Science Apps", price: 110.20, change: 0.1 },
            { sym: "KTOS", name: "Kratos Defense", price: 18.90, change: 1.5 }
        ],

        // Helper to query simulated data
        queryIntel: function(keyword) {
            return this.intel.filter(i => 
                i.title.toLowerCase().includes(keyword.toLowerCase()) || 
                i.source.toLowerCase().includes(keyword.toLowerCase())
            );
        },

        // Data Generator for "Live" graphs
        generateTraffic: function() {
            // Returns an array of random bytes for visualizers
            return Array.from({length: 20}, () => Math.floor(Math.random() * 100));
        }
    };

    /* -------------------------------------------------------------------------
       REGISTERING CORE APPLICATIONS
       This connects the Visuals (Part 1) with the Logic (Part 4/5)
       ------------------------------------------------------------------------- */
    
    // 1. INTELLIGENCE HUB
    Kernel.registerApp('intel', {
        title: 'INTELLIGENCE HUB',
        icon: 'fas fa-satellite-dish',
        color: '#60a5fa',
        w: 900, h: 600,
        html: (wid) => `
            <div class="flex h-full">
                <div class="flex-col p-4 border-r" style="width: 250px; background: rgba(0,0,0,0.3);">
                    <div class="text-xs text-muted font-bold mb-2">TARGET VECTOR</div>
                    <input type="text" id="${wid}-search" placeholder="e.g. Hypersonic..." value="J-35">
                    
                    <div class="text-xs text-muted font-bold mt-4 mb-2">SOURCE FILTER</div>
                    <select id="${wid}-source">
                        <option value="ALL">GLOBAL AGGREGATION</option>
                        <option value="REDDIT">UNDERGROUND (REDDIT)</option>
                        <option value="NEWS">OFFICIAL (NEWS)</option>
                        <option value="DARK">DARK WEB (SIM)</option>
                    </select>

                    <button class="btn btn-green mt-4" onclick="Apps.Intel.scan('${wid}')">
                        <i class="fas fa-radar"></i> INITIATE SCAN
                    </button>

                    <div class="grow"></div>
                    <div class="p-2 border rounded bg-black text-xs text-muted font-mono">
                        STATUS: READY<br>UPLINK: ACTIVE<br>NODES: 4,021
                    </div>
                </div>

                <div class="flex-col grow bg-black relative">
                    <div id="${wid}-loader" class="hidden absolute top-0 left-0 w-full h-full bg-black flex flex-col items-center justify-center z-50 opacity-90">
                        <div class="spinner mb-4"></div>
                        <div class="text-cyan text-xs tracking-wide">DECRYPTING DATA STREAMS...</div>
                    </div>
                    
                    <div class="p-2 border-b flex justify-between items-center bg-panel">
                        <span class="text-xs font-bold text-muted">LIVE INTERCEPT FEED</span>
                        <div class="flex gap-2">
                            <button class="btn p-1" style="font-size:10px;">EXPORT CSV</button>
                            <button class="btn p-1" style="font-size:10px;">MAP VIEW</button>
                        </div>
                    </div>

                    <div id="${wid}-feed" class="grow overflow-auto p-4 flex-col gap-2">
                        <div class="flex flex-col items-center justify-center h-full text-muted">
                            <i class="fas fa-search fa-3x mb-4 opacity-20"></i>
                            <div>NO ACTIVE SCANS</div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        init: (wid) => {
            // Optional: Auto-scan on open
            // Apps.Intel.scan(wid);
        }
    });

    // 2. GLOBAL MAP
    Kernel.registerApp('map', {
        title: 'GEOSPATIAL COMMAND',
        icon: 'fas fa-globe-americas',
        color: '#4ade80',
        w: 1000, h: 700,
        html: (wid) => `
            <div class="flex flex-col h-full relative">
                <div id="${wid}-map-container" class="grow bg-black"></div>
                
                <div class="absolute bottom-4 left-4 p-2 bg-panel border rounded shadow-lg text-xs font-mono z-[500]">
                    <div class="text-green">‚óè SATELLITE LINK ESTABLISHED</div>
                    <div>LAT: <span id="${wid}-lat">0.00</span> | LNG: <span id="${wid}-lng">0.00</span></div>
                </div>
            </div>
        `,
        init: (wid) => {
            setTimeout(() => Apps.Map.init(wid), 100);
        }
    });

    // 3. TERMINAL
    Kernel.registerApp('terminal', {
        title: 'COMMAND SHELL [ROOT]',
        icon: 'fas fa-terminal',
        color: '#d1d5db',
        w: 600, h: 400,
        html: (wid) => `
            <div class="term-container h-full flex flex-col" onclick="document.getElementById('${wid}-input').focus()">
                <div class="term-header text-muted mb-2">
                    SkyWatch Kernel [v20.0-ENTERPRISE]<br>
                    (c) 2026 Citadel Defense Systems. All rights reserved.<br>
                    Type 'help' for available commands.
                </div>
                <div id="${wid}-history" class="flex-col"></div>
                <div class="flex mt-1">
                    <span class="text-green mr-2">root@skywatch:~#</span>
                    <input type="text" id="${wid}-input" class="bg-transparent border-none p-0 w-full text-green font-mono focus:outline-none" autocomplete="off">
                </div>
            </div>
        `,
        init: (wid) => Apps.Terminal.init(wid)
    });

</script>
        <script>
    /* -------------------------------------------------------------------------
       APPLICATION LOGIC CONTROLLERS
       ------------------------------------------------------------------------- */
    const Apps = {
        
        // --- 1. INTEL HUB LOGIC ---
        Intel: {
            scan: async function(wid) {
                const search = document.getElementById(`${wid}-search`).value;
                const feed = document.getElementById(`${wid}-feed`);
                const loader = document.getElementById(`${wid}-loader`);
                
                // Show Loader
                loader.classList.remove('hidden');
                AudioSys.sfx('scan');

                // Simulate Network Delay for Realism
                await new Promise(r => setTimeout(r, 1500));
                
                // Clear Feed
                feed.innerHTML = '';
                loader.classList.add('hidden');

                // FETCH DATA (Hybrid: Real Google RSS + Sim Fallback)
                let results = [];
                
                try {
                    // Attempt Real Fetch via Proxy
                    const url = `https://news.google.com/rss/search?q=${encodeURIComponent(search)} when:7d&hl=en-US&gl=US&ceid=US:en`;
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    
                    if(data.items) {
                        data.items.forEach(item => {
                            results.push({
                                source: item.source || "WEB INTEL",
                                title: item.title,
                                link: item.link,
                                date: item.pubDate.split(' ')[0],
                                threat: Math.random() > 0.7 ? 'HIGH' : 'LOW'
                            });
                        });
                    }
                } catch(e) {
                    // Fallback to Black Vault if offline
                    results = BlackVault.queryIntel(search);
                }

                // Render Results
                if(results.length === 0) {
                    feed.innerHTML = `<div class="p-4 text-center text-muted">NO INTELLIGENCE FOUND FOR VECTOR: ${search}</div>`;
                } else {
                    results.forEach(item => {
                        const isHigh = item.threat === 'HIGH' || item.threat === 'CRIT';
                        const colorClass = isHigh ? 'border-l-4 border-red-500 bg-red-900/10' : 'border-l-4 border-cyan-500 bg-cyan-900/10';
                        
                        feed.innerHTML += `
                            <div class="p-3 bg-panel border border-mid mb-2 ${colorClass} hover:bg-white/5 transition-colors cursor-pointer group relative overflow-hidden">
                                <div class="flex justify-between text-xs text-muted mb-1 font-mono uppercase">
                                    <span>${item.source}</span>
                                    <span>${item.date}</span>
                                </div>
                                <div class="text-sm font-bold text-white group-hover:text-cyan mb-1" onclick="window.open('${item.link}')">
                                    ${item.title}
                                </div>
                                <div class="flex gap-2 mt-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                    <button class="btn p-1 text-xs" onclick="Apps.AI.analyzeQuick('${item.title}')"><i class="fas fa-brain"></i> ANALYZE</button>
                                    <button class="btn p-1 text-xs"><i class="fas fa-share-alt"></i> UPLINK</button>
                                </div>
                            </div>
                        `;
                    });
                    AudioSys.sfx('open');
                }
            }
        },

        // --- 2. MAP LOGIC ---
        Map: {
            init: function(wid) {
                const container = document.getElementById(`${wid}-map-container`);
                if(!container) return;

                const map = L.map(container, {
                    zoomControl: false,
                    attributionControl: false
                }).setView([20, 0], 2);

                // Sci-Fi Dark Map Style
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 18
                }).addTo(map);

                // Add Live Trackers
                const targets = [
                    { lat: 33.6, lng: 73.0, name: "ISLAMABAD UPLINK" },
                    { lat: 38.9, lng: -77.0, name: "PENTAGON NODE" },
                    { lat: 51.5, lng: -0.1, name: "LONDON GCHQ" },
                    { lat: 35.6, lng: 139.6, name: "TOKYO UNIT 8200" },
                    { lat: 55.7, lng: 37.6, name: "MOSCOW MONITOR" }
                ];

                targets.forEach(t => {
                    const circle = L.circleMarker([t.lat, t.lng], {
                        color: '#00f3ff',
                        fillColor: '#00f3ff',
                        fillOpacity: 0.5,
                        radius: 6
                    }).addTo(map);
                    
                    circle.bindPopup(`<b style="color:#000">${t.name}</b><br>STATUS: ACTIVE`);
                });

                // Update coords on mousemove
                map.on('mousemove', (e) => {
                    document.getElementById(`${wid}-lat`).innerText = e.latlng.lat.toFixed(4);
                    document.getElementById(`${wid}-lng`).innerText = e.latlng.lng.toFixed(4);
                });
            }
        },

        // --- 3. TERMINAL LOGIC ---
        Terminal: {
            init: function(wid) {
                const input = document.getElementById(`${wid}-input`);
                const history = document.getElementById(`${wid}-history`);

                input.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter') {
                        const cmd = input.value.trim();
                        if(!cmd) return;
                        
                        // Add to history
                        this.log(history, `root@skywatch:~# ${cmd}`, 'text-green');
                        input.value = '';

                        // Process Command
                        this.exec(wid, cmd, history);
                    }
                });
                // Focus input on click
                document.querySelector(`#${wid} .term-container`).addEventListener('click', () => input.focus());
            },

            log: function(container, text, colorClass = 'text-white') {
                const div = document.createElement('div');
                div.className = `term-line ${colorClass} font-mono text-xs break-all`;
                div.innerText = text;
                container.appendChild(div);
                container.parentElement.scrollTop = container.parentElement.scrollHeight;
            },

            exec: function(wid, cmd, history) {
                const args = cmd.toLowerCase().split(' ');
                
                switch(args[0]) {
                    case 'help':
                        this.log(history, "AVAILABLE COMMANDS: scan, clear, ip, whoami, reboot, defcon", "text-muted");
                        break;
                    case 'clear':
                        history.innerHTML = '';
                        break;
                    case 'whoami':
                        this.log(history, "USER: COMMANDER FAHAD // LEVEL 5 ACCESS", "text-cyan");
                        break;
                    case 'ip':
                        this.log(history, "192.168.44.102 (SECURE VPN TUNNEL)", "text-amber");
                        break;
                    case 'reboot':
                        this.log(history, "SYSTEM REBOOT INITIATED...", "text-red");
                        setTimeout(() => location.reload(), 1000);
                        break;
                    case 'defcon':
                         if(args[1]) {
                             this.log(history, `DEFCON LEVEL SET TO ${args[1]}`, "text-red");
                             AudioSys.sfx('error');
                         } else {
                             this.log(history, "USAGE: defcon [1-5]", "text-muted");
                         }
                        break;
                    default:
                        this.log(history, `COMMAND NOT FOUND: ${args[0]}`, "text-red");
                }
            }
        },

        // --- 4. AI & NEURAL LOGIC ---
        AI: {
            analyzeQuick: function(text) {
                // Open AI Window if not open
                if(!Kernel.windows['ai_core']) Kernel.open('ai');
                
                // Find active AI window ID
                const wins = Object.keys(Kernel.windows);
                const aiWin = wins.find(id => id.includes('win_ai'));
                
                if(aiWin) {
                    const input = document.getElementById(`${aiWin}-prompt`);
                    if(input) input.value = `Analyze threat level: "${text}"`;
                    Kernel.focus(aiWin);
                }
            },
            
            run: async function(wid) {
                const prompt = document.getElementById(`${wid}-prompt`).value;
                const key = document.getElementById(`${wid}-key`).value;
                const out = document.getElementById(`${wid}-output`);

                if(!key) { 
                    out.innerHTML += `\n<span class="text-red">> ERROR: MISSING API KEY</span>`; 
                    return; 
                }

                out.innerHTML += `\n<span class="text-cyan">> UPLOADING TO NEURAL NET...</span>`;
                AudioSys.sfx('scan');

                try {
                    const res = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                        body: JSON.stringify({
                            model: "gpt-4o-mini",
                            messages: [{role: "user", content: "Analyze this intel for threats and tactical relevance: " + prompt}]
                        })
                    });
                    const data = await res.json();
                    const reply = data.choices[0].message.content;
                    
                    // Typewriter effect for output
                    out.innerHTML += `\n<span class="text-green">> ANALYSIS COMPLETE:</span>\n`;
                    out.innerHTML += `<div class="p-2 border border-dim bg-black/50 text-xs">${reply}</div>`;
                    out.scrollTop = out.scrollHeight;
                    
                } catch(e) {
                    out.innerHTML += `\n<span class="text-red">> UPLINK FAILED: CONNECTION RESET</span>`;
                }
            }
        }
    };

    /* -------------------------------------------------------------------------
       REGISTER REMAINING APPS
       ------------------------------------------------------------------------- */
    
    // 4. NEURAL CORE (AI)
    Kernel.registerApp('ai', {
        title: 'NEURAL NET INTERFACE',
        icon: 'fas fa-brain',
        color: '#f472b6',
        w: 700, h: 500,
        html: (wid) => `
            <div class="flex flex-col h-full p-4 gap-4">
                <div class="flex-col grow relative">
                    <div class="absolute top-0 left-0 text-xs font-mono text-muted mb-2">INPUT VECTOR</div>
                    <textarea id="${wid}-prompt" class="w-full h-24 bg-black border border-mid p-2 text-white font-mono text-sm resize-none focus:border-pink-500" placeholder="Paste intelligence data here for classification..."></textarea>
                </div>
                
                <div class="flex gap-2 items-center">
                    <i class="fas fa-key text-muted"></i>
                    <input type="password" id="${wid}-key" class="bg-black border border-mid p-2 text-xs w-64" placeholder="OPENAI API KEY (sk-...)">
                    <div class="grow"></div>
                    <button class="btn btn-primary" onclick="Apps.AI.run('${wid}')">
                        <i class="fas fa-microchip"></i> EXECUTE MODEL
                    </button>
                </div>

                <div class="grow bg-black border border-mid p-2 font-mono text-xs overflow-auto relative" id="${wid}-output">
                    <div class="absolute top-0 right-0 p-1 text-[10px] text-muted">GPT-4o NODE</div>
                    <span class="text-pink-500">> SYSTEM READY. WAITING FOR INPUT...</span>
                </div>
            </div>
        `
    });

    // 5. MARKET WATCH (STOCKS)
    Kernel.registerApp('stocks', {
        title: 'FINANCIAL WARFARE',
        icon: 'fas fa-chart-line',
        color: '#facc15',
        w: 800, h: 500,
        html: (wid) => `
            <div class="flex h-full">
                <div class="w-64 border-r border-dim bg-black/30 flex-col overflow-auto">
                    ${BlackVault.stocks.map(s => `
                        <div class="p-3 border-b border-dim hover:bg-white/5 cursor-pointer flex justify-between items-center group">
                            <div>
                                <div class="font-bold text-sm text-white">${s.sym}</div>
                                <div class="text-[10px] text-muted">${s.name}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-mono text-white">${s.price}</div>
                                <div class="text-[10px] font-mono ${s.change > 0 ? 'text-green' : 'text-red'}">
                                    ${s.change > 0 ? '+' : ''}${s.change}%
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="grow flex flex-col p-4 relative">
                    <div class="text-xs text-muted mb-2 font-bold">LMT // LOCKHEED MARTIN CORP</div>
                    <div class="grow relative">
                        <canvas id="${wid}-chart"></canvas>
                    </div>
                </div>
            </div>
        `,
        init: (wid) => {
            const ctx = document.getElementById(`${wid}-chart`).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00'],
                    datasets: [{
                        label: 'PRICE ACTION',
                        data: [448, 452, 449, 455, 453, 460, 458],
                        borderColor: '#facc15',
                        backgroundColor: 'rgba(250, 204, 21, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#222' }, ticks: { color: '#666' } },
                        y: { grid: { color: '#222' }, ticks: { color: '#666' } }
                    }
                }
            });
        }
    });

    // 6. SYSTEM SETTINGS
    Kernel.registerApp('settings', {
        title: 'SYSTEM CONFIG',
        icon: 'fas fa-sliders-h',
        color: '#a78bfa',
        w: 400, h: 300,
        html: (wid) => `
            <div class="p-6 flex flex-col gap-4">
                <div>
                    <div class="text-xs font-bold text-muted mb-2">INTERFACE THEME</div>
                    <div class="flex gap-2">
                        <button class="w-8 h-8 rounded bg-cyan-500 border-2 border-white" onclick="document.documentElement.style.setProperty('--cyan', '#00f3ff')"></button>
                        <button class="w-8 h-8 rounded bg-red-500 border border-dim" onclick="document.documentElement.style.setProperty('--cyan', '#ef4444')"></button>
                        <button class="w-8 h-8 rounded bg-green-500 border border-dim" onclick="document.documentElement.style.setProperty('--cyan', '#10b981')"></button>
                        <button class="w-8 h-8 rounded bg-purple-500 border border-dim" onclick="document.documentElement.style.setProperty('--cyan', '#8b5cf6')"></button>
                    </div>
                </div>
                
                <div>
                    <div class="text-xs font-bold text-muted mb-2">AUDIO</div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" checked class="accent-cyan-500">
                        <span class="text-sm">UI Sound Effects</span>
                    </label>
                </div>

                <div class="mt-auto pt-4 border-t border-dim">
                    <button class="btn btn-red w-full" onclick="Kernel.reboot()">
                        <i class="fas fa-sync"></i> FACTORY RESET
                    </button>
                </div>
            </div>
        `
    });

</script>
    </div>
    <script>
    /* -------------------------------------------------------------------------
       DESKTOP VISUAL EFFECTS (PARTICLE SYSTEM)
       Adds the moving "constellation" background to the desktop.
       ------------------------------------------------------------------------- */
    const DesktopFX = {
        canvas: null,
        ctx: null,
        particles: [],
        width: 0,
        height: 0,

        init: function() {
            // Create Canvas
            this.canvas = document.createElement('canvas');
            this.canvas.style.position = 'absolute';
            this.canvas.style.top = '0';
            this.canvas.style.left = '0';
            this.canvas.style.width = '100%';
            this.canvas.style.height = '100%';
            this.canvas.style.zIndex = '0';
            this.canvas.style.pointerEvents = 'none';
            document.getElementById('desktop-layer').insertBefore(this.canvas, document.getElementById('desktop-icons'));
            
            this.ctx = this.canvas.getContext('2d');
            
            // Resize Handler
            window.addEventListener('resize', () => this.resize());
            this.resize();

            // Create Particles
            for(let i=0; i<80; i++) {
                this.particles.push({
                    x: Math.random() * this.width,
                    y: Math.random() * this.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2
                });
            }

            this.animate();
        },

        resize: function() {
            this.width = window.innerWidth;
            this.height = window.innerHeight;
            this.canvas.width = this.width;
            this.canvas.height = this.height;
        },

        animate: function() {
            this.ctx.clearRect(0, 0, this.width, this.height);
            this.ctx.fillStyle = 'rgba(0, 243, 255, 0.3)';
            this.ctx.strokeStyle = 'rgba(0, 243, 255, 0.1)';

            this.particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;

                // Bounce
                if(p.x < 0 || p.x > this.width) p.vx *= -1;
                if(p.y < 0 || p.y > this.height) p.vy *= -1;

                this.ctx.beginPath();
                this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                this.ctx.fill();

                // Draw Connections
                for(let j=i+1; j<this.particles.length; j++) {
                    const p2 = this.particles[j];
                    const dx = p.x - p2.x;
                    const dy = p.y - p2.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);

                    if(dist < 150) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(p.x, p.y);
                        this.ctx.lineTo(p2.x, p2.y);
                        this.ctx.stroke();
                    }
                }
            });

            requestAnimationFrame(() => this.animate());
        }
    };

    /* -------------------------------------------------------------------------
       SYSTEM BOOTLOADER
       ------------------------------------------------------------------------- */
    
    // Hook into Kernel Desktop Init to start FX
    const originalInitDesktop = Kernel.initDesktop;
    Kernel.initDesktop = function() {
        originalInitDesktop.call(this); // Run original logic
        DesktopFX.init(); // Start Particles
    };

    // Start System
    window.onload = () => {
        console.log("%c SKYWATCH ENTERPRISE v20.0 ", "background: #000; color: #00f3ff; font-size: 20px; font-weight: bold;");
        console.log("System Integrity Check... OK");
        
        // Prevent accidental back navigation
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            history.go(1);
        };

        // Launch Kernel
        Kernel.init();
    };

</script>
</body>
</html>
